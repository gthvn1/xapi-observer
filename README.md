# Description

## Notes

- In fact with grafana Alloy, we can take a trace generated by XAPI and produce an OTel trace.
  - https://grafana.com/docs/alloy/latest/reference/components/otelcol/otelcol.receiver.zipkin/
- Test using:
  - A docker container:
```sh
#!/bin/bash

docker run \
	-v "$(pwd)/config.alloy:/etc/alloy/config.alloy" \
	-v /tmp/log:/tmp/log \
	-p 12345:12345 \
	-p 9411:9411 \
	grafana/alloy:latest \
		run \
				--server.http.listen-addr=0.0.0.0:12345 \
				--storage.path=/var/lib/alloy/data \
				--stability.level=experimental \
				/etc/alloy/config.alloy
```
  - And the following alloy configuration (it accepts Zipkin spans and write output on console)
```
â¯ cat config.alloy
logging {
  level  = "debug"
  format = "logfmt"
}

otelcol.receiver.zipkin "zipkin" {
  endpoint = "0.0.0.0:9411"
  output  {
		traces = [otelcol.exporter.debug.console.input]
  }
}

otelcol.exporter.debug "console" {
  verbosity = "detailed"
}
```

- Once started you can take a xapi trace (ndjson), concatenate tables and send it to alloy. You should see on console that it is read:
```sh
# jq -s 'add' xapi-6e7e2f49-3168-465e-a22c-93f68f1c31ab-2026-02-19T20:46:15.393923-00:00.ndjson > spans.json
# curl -X POST http://localhost:9411/api/v2/spans \
  -H "Content-Type: application/json" \
  --data @spans.json
```

---

**xapi-observer** is an open-source observability tool for the Xen XAPI toolstack.
It parses XAPI traces (Zipkin JSON), converts them to OpenTelemetry, and integrates with Grafana,
Tempo, and Loki for scalable trace and log analysis.

- **Development setup**: I use a tmux session split into two panes: one running [air](https://github.com/air-verse/air) for hot-reload, and the other for coding.

- I can do TDD using: `air --build.cmd "go test . -v"`

# Status

- [ ] Read Zipkin traces (XAPI observer)
- [ ] Convert to OpenTelemetry format
- [ ] Transfer them via OTLP to Tempo using a Collector
- [ ] Visualize data in Grafana
- [ ] Enrich data with XAPI logs

# Example of traces

```json
[
  {
    "tags": {
      "xs.xapi.task.id": "D:a53289ce0d41",
      "xs.xapi.session.track.id": "ed027918fda74f47eec4b3ac1de88018",
      "xs.pool.uuid": "0496aa55-4e6f-363d-6578-4ab872ddfb9e",
      "xs.observer.name": "local observer",
      "xs.host.uuid": "cb043a21-9c51-4418-a1e8-e7079ac6dc1a",
      "xs.host.name": "xcp-gtn-ip13",
      "service.name": "xapi"
    },
    "annotations": [],
    "localEndpoint": {
      "serviceName": "xapi"
    },
    "kind": "SERVER",
    "duration": 2,
    "timestamp": 1751469555858327,
    "name": "TaskHelper.get_name",
    "parentId": "873b73d304891032",
    "traceId": "0a07bfbf3925e3d4776995171a9222cd",
    "id": "d4bcd152c96bd105"
  },
  {
    "tags": {
      "xs.xapi.task.id": "D:31bcb54f6757",
      "xs.pool.uuid": "0496aa55-4e6f-363d-6578-4ab872ddfb9e",
      "xs.observer.name": "local observer",
      "xs.host.uuid": "cb043a21-9c51-4418-a1e8-e7079ac6dc1a",
      "xs.host.name": "xcp-gtn-ip13",
      "service.name": "xapi"
    },
    "annotations": [],
    "localEndpoint": {
      "serviceName": "xapi"
    },
    "duration": 2,
    "timestamp": 1751469555858210,
    "name": "TaskHelper.destroy",
    "traceId": "72aa2c3749bd41b16b9fd1b1d47b782a",
    "id": "fcdd53da8eb51fee"
  },
  {
    "tags": {
      "xs.xapi.task.uuid": "00000000-0000-0000-0000-000000000000",
      "xs.xapi.task.origin": "internal",
      "xs.xapi.task.name": "session_check",
      "xs.xapi.task.id": "D:31bcb54f6757",
      "xs.pool.uuid": "0496aa55-4e6f-363d-6578-4ab872ddfb9e",
      "xs.observer.name": "local observer",
      "xs.host.uuid": "cb043a21-9c51-4418-a1e8-e7079ac6dc1a",
      "xs.host.name": "xcp-gtn-ip13",
      "service.name": "xapi"
    },
    "annotations": [],
    "localEndpoint": {
      "serviceName": "xapi"
    },
    "duration": 82,
    "timestamp": 1751469555858125,
    "name": "session_check",
    "traceId": "8ba5b078e801c1dc85dc38e32bf39dcc",
    "id": "5fb761b593cbd395"
  },
  ...
```
